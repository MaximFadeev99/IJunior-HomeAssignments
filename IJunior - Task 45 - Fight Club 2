using System;
using System.Collections.Generic;

namespace CSTest2
{
    internal class Program
    {
        static void Main(string[] args)
        {
            Arena arena = new Arena();

            arena.Work();            
        }
    }

    abstract class Champion
    {
        public Champion(string name, int health, int armor, int damage, int initiative)
        {
            Name = name;
            Health = health;
            Armor = armor;
            Damage = damage;
            Initiative = initiative;
        }

        public string Name { get; private set; }
        public int Health { get; protected set; }
        public int Armor { get; private set; }
        public int Damage { get; protected set; }
        public int Initiative { get; private set; }

        public void ShowStats()
        {
            Console.Write($"{Name}      -     {Health}      -      {Armor}     -     {Damage}     -     {Initiative}\n");
        }

        public virtual void Attack(Champion enemy)
        {
            Console.WriteLine($"\n{Name} наносит атаку в {Damage} ед. урона");
            enemy.TakeDamage(Damage);
        }

        public virtual void TakeDamage(int incomingDamage)
        {
            Health -= incomingDamage;
            Console.WriteLine($"\n{Name} получает {incomingDamage} ед. урона");
            Health = LimitHealthFall(Health);
            Console.WriteLine($"Оставшееся здоровье - {Health}");
        }

        protected int LimitHealthFall(int currentHealth)
        {
            if (currentHealth < 0)
                currentHealth = 0;

            return currentHealth;
        }
    }

    class LightFighter : Champion
    {
        public LightFighter() : base("Дрыщ", 300, 0, 50, 80) { }

        public override void TakeDamage(int incomingDamage)
        {
            if (IsDodging() == false)
            {
                Health -= incomingDamage;
            }
            else
            {
                incomingDamage = 0;
            }

            Health = LimitHealthFall(Health);
            Console.WriteLine($"\n{Name} получает {incomingDamage} ед. урона. \nОставшееся здоровье - {Health}");
        }

        private bool IsDodging()
        { 
            int successThreshold = 33;
            int dodgeChance = RandomNumber.Generate();
            bool isDodging;

            if (dodgeChance <= successThreshold)
            {
                isDodging = true;
                Console.Write($"\n{Name} уклоняется от вражеской атаки");
            }
            else
            {
                isDodging = false;
            }

            return isDodging;
        }
    }

    class MediumFighter : Champion
    {
        public MediumFighter() : base("Крепыш", 350, 0, 55, 60) { }

        public override void TakeDamage(int incomingDamage)
        {
            Health -= incomingDamage;
            Console.WriteLine($"\n{Name} получает {incomingDamage} ед. урона");
            CanHeal();
            Health = LimitHealthFall(Health);
            Console.WriteLine($"Оставшееся здоровье - {Health}");
        }

        private void CanHeal()
        {
            int successThreshold = 33;
            int healChance = RandomNumber.Generate();
            double healPercent = 0.1;
            double restoredHealth;
            int initialHealth = 350;

            if (healChance <= successThreshold)
            {
                restoredHealth = Health * healPercent;

                if (Health + Convert.ToInt32(restoredHealth) > initialHealth)
                {
                    Health = initialHealth;
                }
                else
                {
                    Health += Convert.ToInt32(restoredHealth);
                }

                Console.WriteLine($"{Name} восстанавливает {Convert.ToInt32(restoredHealth)} о.з.");
            }
        }
    }

    class BackStabber : Champion
    {
        public BackStabber() : base("Крыса", 280, 0, 50, 90) { }

        public override void Attack(Champion enemy)
        {
            int damageMultiplier = 2;
            int initialDamage = 50;

            if (CanUseShiv() == true)
            {
                Damage *= damageMultiplier;
                Console.WriteLine($"\n{Name} использует заточку и удваивает урон");
            }
            else
            {
                Damage = initialDamage;
            }

            Console.WriteLine($"\n{Name} наносит атаку в {Damage} ед. урона");
            enemy.TakeDamage(Damage);
        }

        private bool CanUseShiv()
        {
            int successThreshold = 33;
            int useChance = RandomNumber.Generate();
            bool isSuccessful;

            if (useChance <= successThreshold)
            {
                isSuccessful = true;
            }
            else
            {
                isSuccessful = false;
            }

            return isSuccessful;
        }
    }

    class FatGuy : Champion
    {
        public FatGuy() : base("Жиробас", 300, 25, 60, 50) { }

        public override void TakeDamage(int incomingDamage)
        {
            double reducedDamage;
            double maxPercent = 100;

            reducedDamage = incomingDamage * ((maxPercent - Armor) / maxPercent);
            Health -= Convert.ToInt32(reducedDamage);

            Health = LimitHealthFall(Health);
            Console.WriteLine($"\n{Name} получает {Convert.ToInt32(reducedDamage)} ед. урона");
            Console.WriteLine($"Оставшееся здоровье - {Health}");
        }
    }

    class Boxer : Champion
    {
        private int _hitsCount = 0;
        private double _damageModifier = 1.2;

        public Boxer() : base("Боксер", 270, 0, 55, 55) { }

        public override void Attack(Champion enemy)
        {
            double modifiedDamage;
            int initialDamage = 55;

            if (_hitsCount == 3)
            {
                modifiedDamage = Damage * _damageModifier;
                Damage += Convert.ToInt32(modifiedDamage);
                _hitsCount = 0;
                Console.WriteLine($"\n{Name} бьет коронный и увеличивает урон");
            }
            else
            {
                Damage = initialDamage;
                _hitsCount++;
            }

            Console.WriteLine($"\n{Name} наносит атаку в {Damage} ед. урона");
            enemy.TakeDamage(Damage);
        }
    }

    class Arena 
    {
        private List<Champion> _champions;

        public void Work() 
        {
            while (true)
            {
                GenerateNewChampions();
                ChooseChampions(out Champion firstChampion, out Champion secondChampion);
                AnnounceWinner(Fight(firstChampion, secondChampion));
                Console.ReadKey();
                Console.Clear();
            }          
        }

        private void GenerateNewChampions() 
        {
            _champions = new List<Champion>() 
                {new LightFighter(), 
                new MediumFighter(), 
                new BackStabber(), 
                new FatGuy(), 
                new Boxer()};
        }

        private void ChooseChampions(out Champion firstChampion, out Champion secondChampion) 
        {
            Console.WriteLine("Имя бойца    -   Здоровье    -    Броня   -   " +
            "Урон   -   Инициатива\n");

            for (int i = 0; i < _champions.Count; i++)
            {
                Console.Write(i + 1 + ") ");
                _champions[i].ShowStats();
            }

            firstChampion = EnquireChampionNumber();
            secondChampion = EnquireChampionNumber();

            while (firstChampion == secondChampion)
            {
                Console.Write("Ошибка!Второй боец уже занят!");
                secondChampion = EnquireChampionNumber();
            }
        }

        private Champion EnquireChampionNumber()
        {
            string userInput;
            int championNumber;

            Console.Write("\nВведите номер бойца: ");
            userInput = Console.ReadLine();

            while (int.TryParse(userInput, out championNumber) == false || championNumber - 1 < 0 || championNumber > _champions.Count)
            {
                Console.Write("Ошибка! Введите повторно номер бойца: ");
                userInput = Console.ReadLine();
            }

            return _champions[championNumber - 1];
        }

        private Champion Fight(Champion firstChampion, Champion secondChampion) 
        {

            while (firstChampion.Health > 0 && secondChampion.Health > 0)
            {
                if (firstChampion.Initiative > secondChampion.Initiative)
                {
                    firstChampion.Attack(secondChampion);

                    if (secondChampion.Health == 0) 
                        return firstChampion;

                    secondChampion.Attack(firstChampion);

                    if (firstChampion.Health == 0)
                        return secondChampion;
                }
                else
                {
                    secondChampion.Attack(firstChampion);

                    if (firstChampion.Health == 0)
                       return secondChampion;

                    firstChampion.Attack(secondChampion);

                    if (secondChampion.Health == 0)
                        return firstChampion;
                }
            }

            return null;
        }

        private void AnnounceWinner(Champion winner) 
        {
            Console.WriteLine($"\nПобедил {winner.Name}!");
        }
    }

    static class RandomNumber 
    {
        private static Random _seed = new Random();
        private static int minValue = 1;
        private static int maxValue = 101;

        public static int Generate() 
        {
            int newNumber = _seed.Next(minValue, maxValue);

            return newNumber;
        }
    }
}
